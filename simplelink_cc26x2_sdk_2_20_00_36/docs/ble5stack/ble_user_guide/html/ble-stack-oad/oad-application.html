

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>OAD Application &mdash; SimpleLink™ CC26x2 SDK BLE5-Stack User&#39;s Guide 1.02.01.00 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="SimpleLink™ CC26x2 SDK BLE5-Stack User&#39;s Guide 1.02.01.00 documentation" href="../index.html"/>
        <link rel="up" title="Over-the-Air Download (OAD)" href="index.html"/>
        <link rel="next" title="BLE-Stack OAD Profile" href="oad-profile.html"/>
        <link rel="prev" title="OAD Image Tool" href="../oad/tools.html"/> 
    <script language="JavaScript">
        var tiPageName;
        tiPageName = "sug ble-stack-oad oad-application";

        if (location.protocol == "file:"){
            var ci_analytics_poc_load = true;
        }
    </script> 

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8">     



  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">
  <header id="tiHeader">
    <div class="top">
      <ul>
        <li id="top_logo">
          <a href="http://www.ti.com">
            <img src="../_static/img/ti_logo.png"/>
          </a>
        </li>
      </ul>
    </div>
    <div class="nav"></div>
  </header>
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../ble-stack-5.x-guide/index-cc26x2.html" class="icon icon-home"> SimpleLink™ CC26x2 SDK BLE5-Stack User's Guide
          

          
          </a>

          
            
            
              <div class="version">
                1.02.01.00
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul class="current">
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/disclaimer.html">Disclaimer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/platform-cc26x2.html">The CC26x2 SDK Platform</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-tirtos/index.html">TI-RTOS (RTOS Kernel) Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x/index-cc26x2.html">Developing a Bluetooth Low Energy Application</a></li>
<li class="toctree-l1"><a class="reference internal" href="../sensor-controller/sensor-controller.html">Sensor Controller</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debugging/ble-index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../energy-trace/energy-trace.html">EnergyTrace User Guide</a></li>
<li class="toctree-l1 current"><a class="reference internal" href="index.html">Over-the-Air Download (OAD)</a><ul class="current">
<li class="toctree-l2"><a class="reference internal" href="../oad/intro.html">Introduction</a></li>
<li class="toctree-l2"><a class="reference internal" href="../oad/bim.html">Boot Image Manager (BIM)</a></li>
<li class="toctree-l2"><a class="reference internal" href="../oad/image-header.html">OAD Image Header</a></li>
<li class="toctree-l2"><a class="reference internal" href="../oad/ext-flash-image-header.html">OAD External Flash Image Header</a></li>
<li class="toctree-l2"><a class="reference internal" href="../oad/flash-layout-off-chip.html">Flash Layout for Off-Chip OAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="../oad/tools.html">OAD Image Tool</a></li>
<li class="toctree-l2 current"><a class="current reference internal" href="#">OAD Application</a><ul>
<li class="toctree-l3"><a class="reference internal" href="#oad-software-architecture">OAD Software Architecture</a></li>
<li class="toctree-l3"><a class="reference internal" href="#oad-state-machine">OAD State Machine</a><ul>
<li class="toctree-l4"><a class="reference internal" href="#image-validation">Image Validation</a></li>
<li class="toctree-l4"><a class="reference internal" href="#image-block-transfers">Image Block Transfers</a></li>
<li class="toctree-l4"><a class="reference internal" href="#completion-of-the-oad-process">Completion of the OAD Process</a></li>
</ul>
</li>
</ul>
</li>
<li class="toctree-l2"><a class="reference internal" href="oad-profile.html">BLE-Stack OAD Profile</a></li>
<li class="toctree-l2"><a class="reference internal" href="setting-up-environment.html">Setting up the BLE OAD Environment</a></li>
<li class="toctree-l2"><a class="reference internal" href="performing-an-oad.html">Performing a BLE OAD</a></li>
<li class="toctree-l2"><a class="reference internal" href="creating-a-production-image.html">Creating a Production Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="revert-to-factory.html">Reverting to a Factory Image</a></li>
<li class="toctree-l2"><a class="reference internal" href="add-ble-oad-to-proj.html">Adding BLE OAD to an Existing Project</a></li>
</ul>
</li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/migration-cc26x2.html">Updating from previous SDKs</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/api-reference.html">API References</a></li>
<li class="toctree-l1"><a class="reference internal" href="../ble-stack-5.x-guide/reference-cc26x2.html">Terms and Definitions</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../ble-stack-5.x-guide/index-cc26x2.html">SimpleLink™ CC26x2 SDK BLE5-Stack User's Guide</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../ble-stack-5.x-guide/index-cc26x2.html">Docs</a> &raquo;</li>
      
          <li><a href="index.html">Over-the-Air Download (OAD)</a> &raquo;</li>
      
    <li>OAD Application</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="oad-application">
<span id="oad-process"></span><h1>OAD Application<a class="headerlink" href="#oad-application" title="Permalink to this headline">¶</a></h1>
<p>The application layer is responsible for plugging the OAD module. The OAD
profile and communication with the BLE-Stack is encapsulated inside the OAD
module. An application developer wishing to implement use the TI OAD solution
will not need to worry about implementing the OAD state machine, but instead can
just include the module and make the proper calls as detailed in
<a class="reference internal" href="add-ble-oad-to-proj.html#sec-add-ble-oad-to-project"><span class="std std-ref">Adding BLE OAD to an Existing Project</span></a>. However, the details of the OAD application
layer are documented here for completeness and to aide in debugging.</p>
<div class="section" id="oad-software-architecture">
<h2>OAD Software Architecture<a class="headerlink" href="#oad-software-architecture" title="Permalink to this headline">¶</a></h2>
<p>The building blocks of the OAD software architecture are detailed below.
In the figure below the following terms have been abbreviated for compactness in
the image.</p>
<blockquote>
<div><ul class="simple">
<li>CB : Callback</li>
<li>SVC: BLE Service</li>
<li>Func: Function</li>
</ul>
</div></blockquote>
<img alt="../_images/ditaa-7382bbf87f7b2caa69a8ed798a00a953afaa88ba.png" src="../_images/ditaa-7382bbf87f7b2caa69a8ed798a00a953afaa88ba.png" />
<p>Internally the OAD module is responsible for the following:</p>
<blockquote>
<div><ul class="simple">
<li>Implementing the OAD profile</li>
<li>Plugging the GATT read and write callback from the BLE5-Stack</li>
<li>Serializing and de-serializing structures from over the messages</li>
<li>Sending OAD related requests and responses to the BLE5-Stack to be sent over
the air</li>
<li>Queuing up messages from stack callbacks to be processed later by the
application</li>
<li>Implementing the OAD state machine, and ensuring proper state transitions</li>
<li>Implementing the OAD inactivity timers</li>
<li>Implementing getter/setter functions for the application to use and
configure the OAD module</li>
</ul>
</div></blockquote>
<p>External to the OAD module the application task is responsible for the
following. See <a class="reference internal" href="add-ble-oad-to-proj.html#sec-add-ble-oad-to-project"><span class="std std-ref">Adding BLE OAD to an Existing Project</span></a> more more information.</p>
<blockquote>
<div><ul class="simple">
<li>Plugging an OAD event handler</li>
<li>Calling the OAD event processing function in a task context when events
are posted.</li>
<li>Resetting the device when the <code class="docutils literal"><span class="pre">OAD_DL_COMPLETE</span></code> event is received.</li>
</ul>
</div></blockquote>
<p>A message sequence chart is included below to show a sample of an application’s
interaction with the OAD module.</p>
<blockquote>
<div><div class="figure align-center" id="id1">
<span id="fig-oad-call-graph"></span><p class="plantuml">
<img src="../_images/plantuml-ffd2a47024f239ae74d0967b4458502b39812cca.png" alt="&#64;startuml
hide footbox

participant app_task.c as app
participant oad.c as oad
participant &quot;BLE Stack&quot; as BLE
participant &quot;OAD Queue&quot; as OADQ

box &quot;BLE-Stack Context&quot;
    participant &quot;GATT R/W Callback&quot; as GATT
end box

activate app

group Initialize OAD Module
    app -&gt; oad : OAD_open()

    activate oad
    oad -&gt; BLE : GATTServApp_InitCharCfg() (repeat for each char CCCD)
    oad -&gt; BLE : GATTServApp_RegisterService()

    oad -&gt; OADQ : Queue_construct()
    deactivate oad

    app -&gt; oad : OAD_register()
end

BLE -&gt; app : ATT_MTU_UPDATED_EVENT
app -&gt; oad : OAD_setBlockSize()


group Processing OAD Service Messages
    note over oad, BLE
        Peer device sends OTA command/write
    end note

    activate GATT
    GATT -&gt; oad : oadWriteAttrCB()

    activate oad
    oad -&gt; OADQ : oadEnqueueMsg()
    oad -&gt; app : Execute (*oadWriteCB_t)
    deactivate OAD
    deactivate GATT

    app -&gt; oad : OAD_processQueue()
    oad -&gt; OADQ : Queue_get()

    note over oad
        Process event
    end note
end

group
&#64;enduml" />
</p>
<p class="caption"><span class="caption-number">Figure 98. </span><span class="caption-text">OAD Module/ Application interaction</span><a class="headerlink" href="#id1" title="Permalink to this image">¶</a></p>
</div>
</div></blockquote>
</div>
<div class="section" id="oad-state-machine">
<h2>OAD State Machine<a class="headerlink" href="#oad-state-machine" title="Permalink to this headline">¶</a></h2>
<p>The OAD module implements an ‘OAD State Machine’ for performing the OAD. The
following state machine depicts the OAD module state transitions and its
interactions with the OAD communication profile messages for both on-chip and
off-chip OAD.</p>
<div class="figure align-center" id="id2">
<span id="fig-oad-state-machine"></span><img alt="../_images/oad_state_machine.png" src="../_images/oad_state_machine.png" />
<p class="caption"><span class="caption-number">Figure 99. </span><span class="caption-text">OAD Types Overview</span></p>
</div>
<p>The states and state transitions are encapsulated inside the OAD module, but
some of the critical states are described below to aide in understanding.</p>
<p>Note these sections refer to internal state handling and transitions local to
the target device. For a summary of the over the air sequence see
<a class="reference internal" href="oad-profile.html#fig-oad-sequence-diagram"><span class="std std-ref">Sequence diagram for OAD process</span></a> and for a breakdown of the different types of
profile messages and how to interpret them over the air please see
<a class="reference internal" href="oad-profile.html#sect-oad-profile"><span class="std std-ref">BLE-Stack OAD Profile</span></a>.</p>
<div class="section" id="image-validation">
<h3>Image Validation<a class="headerlink" href="#image-validation" title="Permalink to this headline">¶</a></h3>
<p>After establishing a new connection, updating the connection interval
for a faster OAD and enabling notifications of OAD Image Identify and
OAD Image Block characteristics on the OAD target, the
OAD distributor shall write to the Image Identify characteristic of the
OAD target. The message data will be the header retrieved from the OAD
Image available for OAD.</p>
<p>On receiving the <cite>Image Identify</cite> message, the
OAD target will verify that the contents of the image can be supported.
This is done by checking the Image Header fields, BIM &amp; header versions, and
length of the image.</p>
<p>The OAD target will then perform boundary checks in the case of an
Application Only or Stack Only OAD. This is done to ensure no boundary violations
will occur between the upgraded image and the images that remain on the device.</p>
</div>
<div class="section" id="image-block-transfers">
<h3>Image Block Transfers<a class="headerlink" href="#image-block-transfers" title="Permalink to this headline">¶</a></h3>
<p>After the Image Validation has completed, the OAD target will switch to
the configuration state. There it will get the block size and set image count.
When the OAD distributor sends the Start OAD Command to the Control
Characteristic (for more details see <a class="reference internal" href="oad-profile.html#tbl-oad-control-supported-commands"><span class="std std-ref">OAD Control Characteristic Supported Commands.</span></a>),
the OAD target will respond with a Control characteristic notification
requesting the first block. The OAD distributor will then send the first block
to the OAD target.</p>
<p>This process continues with the OAD target notifying the OAD distributor
of the next block it needs and the OAD distributor sending the requested
image block until all blocks have been transferred.</p>
</div>
<div class="section" id="completion-of-the-oad-process">
<h3>Completion of the OAD Process<a class="headerlink" href="#completion-of-the-oad-process" title="Permalink to this headline">¶</a></h3>
<p>After receiving the complete image, the CRC32 of the entire image will be
calculated and the’CRC32 status’ bytes will be set accordingly. If the computed
CRC matches with the ‘CRC’ field of received image, it switches to ‘End’ state.</p>
<p>For off-chip OAD, after OAD process is finished, the OAD target checks
that the previous state was OAD Validation. If not, the state machine is reset
and any used buffers are freed.</p>
<p>Next, the Application checks to see if there
are any more images waiting to be downloaded. If there are, the Application
will return to the Image Download state. If there are no more images to download,
the OAD target will check to see if the image that was downloaded should
be copied to internal flash.</p>
<p>If the Enable OAD Image Command has been received, the new image will be copied
to internal flash and the device will be reset. If not, the currently resident
image will continue regular execution.</p>
</div>
</div>
</div>


           </div>
          </div>
          <footer>
  
    <div class="rst-footer-buttons" role="navigation" aria-label="footer navigation">
      
        <a href="oad-profile.html" class="btn btn-neutral float-right" title="BLE-Stack OAD Profile" accesskey="n">Next <span class="fa fa-arrow-circle-right"></span></a>
      
      
        <a href="../oad/tools.html" class="btn btn-neutral" title="OAD Image Tool" accesskey="p"><span class="fa fa-arrow-circle-left"></span> Previous</a>
      
    </div>
  

  <hr/>

  <div role="contentinfo">
    <p>
      <a href="http://www.ti.com/corp/docs/legal/copyright.shtml">2010-2018, Texas Instruments</a>, Texas Instruments Incorporated. All rights reserved. <br>
      <a href="http://www.ti.com/corp/docs/legal/trademark/trademrk.htm">Trademarks</a> | <a href="http://www.ti.com/corp/docs/legal/privacy.shtml">Privacy policy</a> | <a href="http://www.ti.com/corp/docs/legal/termsofuse.shtml">Terms of use</a> | <a href="http://www.ti.com/lsds/ti/legal/termsofsale.page">Terms of sale</a>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.02.01.00',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
        });

      var menuHeight = window.innerHeight;

      var contentOffset = $(".wy-nav-content-wrap").offset();
      var contentHeight = $(".wy-nav-content-wrap").height();
      var contentBottom = contentOffset.top + contentHeight;

      function setNavbarTop() {
          var scrollTop = $(window).scrollTop();
          var maxTop = scrollTop + menuHeight;

          // If past the header
          if (scrollTop > contentOffset.top && maxTop < contentBottom) {
            stickyTop = scrollTop - contentOffset.top;
          } else if (maxTop > contentBottom) {
            stickyTop = scrollTop - contentOffset.top - (maxTop - contentBottom);
          } else {
            stickyTop = 0;
          }

          $(".wy-nav-side").css("top", stickyTop);
      }

      $(document).ready(function() {
        setNavbarTop();
        $(window).scroll(function () {
          setNavbarTop();
        });

        $('body').on("mousewheel", function () {
            // Remove default behavior
            event.preventDefault();
            // Scroll without smoothing
            var wheelDelta = event.wheelDelta;
            var currentScrollPosition = window.pageYOffset;
            window.scrollTo(0, currentScrollPosition - wheelDelta);
        });
      });
  </script>
  
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>