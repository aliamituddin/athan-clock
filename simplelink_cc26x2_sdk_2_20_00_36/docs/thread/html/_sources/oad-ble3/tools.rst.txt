.. _sec-oad-tools:
.. _sec-generating-image-header-vector:

OAD Image Tool
==============

The OAD image tool is a script written in python that is intended to process
the compiler output in the form of a hexfile and prepare the image for over the
air transfer.

The major components of the oad\_image\_tool include:

    - Conversion from \*.hex to \*.bin

    - Padding the image to be word aligned

    - Calculating the CRC and embedding it in the image header

    - Optional: Merging a split image into a single app + stack image
    - Optional: Adding security info to the image header if present

The tool is located in the ``tools/blestack/oad`` folder of the |SDK|.
There are two flavors of the tool, the version which supports security and the
one which does not. They are found in the ``oad_secure`` and ``oad_unsecure``
folders respectively.


Running the tool
----------------

The OAD Image Tool is distributed in both source and binary form. The correct
binary will be bundled with the installer for a given platform (i.e. Linux,
Windows, Mac). However, the tool can also be run in source if desired.

The tool is intended to run as a post build step to an OAD application.  When
run as a post build step, the tool will generate an output binary file named
``<app_name>_oad.bin`` where ``<app_name>`` is the name and path specified by
the required ``-o`` argument to the script.

It is recommended to use the OAD enabled example application from the intended
protocol stack component of the |SDK| and copy + modify the post build step as
needed.


Running the Tool from Source
----------------------------

In general, it is recommended to invoke the tool via the binaries distributed
with the |SDK|. However if it is required to run the tool is source, the
following steps should be taken:

 - Ensure Python is installed on the system (Python 3 recommended)

 - Install the required packages via pip (see ``requirements.txt`` in the
   same folder as the tool)

.. _sec-gen-security-keys:

Generating new security keys
----------------------------

By default, public and private keys will be provided in the ``private.pem``
and ``public.pem`` files. The private key will be used by the OAD image tool to
sign the application image before outputting the binary. The path to the private
key must be provided if using using security, this is provided using the ``-k``
option. You must be using the secure version of the tool to do this.

The default keys are also installed in the BIM projects in order for the out of
box demos to work.

However, before production it is recommended that the customer generate new
keys using the process detailed below:

1. Generate a new keypair by calling ``python keys/key_generate.py`` from
   within the OAD tool folder. This will override the existing ``private.pem``
   ``public.pem``, and ``key_info.txt`` files.

2. Replace the keys used by the BIM with the new ones generated by the tool.
   The code snippet below shows how to do this.
   Replace the "NEW \*\* HERE" placeholders below with the contents of
   the appropriate line in the ``key_info.txt`` file.

.. code-block:: c

    {
        .version    = SECURE_SIGN_TYPE,
        .len        = SECURE_CERT_LENGTH,
        .options    = SECURE_CERT_OPTIONS,
        .signerInfo = {/* NEW SIGNER INFO HERE */},
        .certPayload.eccKey.pubKeyX = {/* NEW PUB KEY X HERE */},
        .certPayload.eccKey.pubKeyY = {/* NEW PUB KEY Y HERE */}
    };

3. The structure above can be found in the following files:

 - Off-chip OAD: ``bim_main.c``
 - On-chip OAD: ``bim_onchip.c``

.. note::

    You will need to add proper C style syntax to the key arrays when pasting
    them into the BIM files. Be sure to add a comma between each element and
    prepends all hex values with ``0x``. Refer to the placeholder keys for
    more information.


Required Arguments/Getting help
-------------------------------

If help is needed when running the tool, invoke it with the ``-h`` option which
will describe the supported features of the tool, the arguments and the actions
they perform.
