

<!DOCTYPE html>
<!--[if IE 8]><html class="no-js lt-ie9" lang="en" > <![endif]-->
<!--[if gt IE 8]><!--> <html class="no-js" lang="en" > <!--<![endif]-->
<head>
  <meta charset="utf-8">
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  
  <title>Localization Toolbox &mdash; SimpleLink™ CC26x2 TI Thread User&#39;s Guide 1.02.00.00 documentation</title>
  

  
  
    <link rel="shortcut icon" href="../_static/favicon.ico"/>
  

  

  
  
    

  

  
  
    <link rel="stylesheet" href="../_static/css/theme.css" type="text/css" />
  

  
    <link rel="stylesheet" href="../_static/theme_overrides.css" type="text/css" />
  
    <link rel="stylesheet" href="../_static/custom.css" type="text/css" />
  

  
        <link rel="index" title="Index"
              href="../genindex.html"/>
        <link rel="search" title="Search" href="../search.html"/>
    <link rel="top" title="SimpleLink™ CC26x2 TI Thread User&#39;s Guide 1.02.00.00 documentation" href="../index.html"/> 
    <script language="JavaScript">
        var tiPageName;
        tiPageName = "sug localization index";

        if (location.protocol == "file:"){
            var ci_analytics_poc_load = true;
        }
    </script> 

    <script src="http://www.ti.com/assets/js/headerfooter/analytics.js" type="text/javascript" charset="utf-8">     



  
  <script src="../_static/js/modernizr.min.js"></script>

</head>

<body class="wy-body-for-nav" role="document">
  <header id="tiHeader">
    <div class="top">
      <ul>
        <li id="top_logo">
          <a href="http://www.ti.com">
            <img src="../_static/img/ti_logo.png"/>
          </a>
        </li>
      </ul>
    </div>
    <div class="nav"></div>
  </header>
  <div class="wy-grid-for-nav">

    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search">
          

          
            <a href="../thread/index-cc26x2.html" class="icon icon-home"> SimpleLink™ CC26x2 TI Thread User's Guide
          

          
          </a>

          
            
            
              <div class="version">
                1.02.00.00
              </div>
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
                <ul>
<li class="toctree-l1"><a class="reference internal" href="../thread/overview.html">Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../cc26x2/index-thread.html">CC26x2 Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../thread/ot-sw-dev-env.html">TI-OpenThread Stack Software Development Environment</a></li>
<li class="toctree-l1"><a class="reference internal" href="../thread/ot-stack-overview.html">TI-OpenThread Stack Overview</a></li>
<li class="toctree-l1"><a class="reference internal" href="../thread/running-example-apps-cc26x2.html">Example Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../thread-br/index.html">Linux Border Router Quick Start</a></li>
<li class="toctree-l1"><a class="reference internal" href="../thread/creating-custom-apps.html">Creating Custom Applications</a></li>
<li class="toctree-l1"><a class="reference internal" href="../thread/custom-hardware.html">Custom Hardware</a></li>
<li class="toctree-l1"><a class="reference internal" href="../thread/packet-sniffer.html">Packet Sniffer</a></li>
<li class="toctree-l1"><a class="reference internal" href="../debugging/thread-index.html">Debugging</a></li>
<li class="toctree-l1"><a class="reference internal" href="../energy-trace/energy-trace.html">EnergyTrace User Guide</a></li>
<li class="toctree-l1"><a class="reference internal" href="../thread-oad/index.html">Over-the-Air Download (OAD)</a></li>
<li class="toctree-l1"><a class="reference internal" href="../thread/migration.html">Migration Guide</a></li>
</ul>

            
          
        </div>
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" role="navigation" aria-label="top navigation">
        <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
        <a href="../thread/index-cc26x2.html">SimpleLink™ CC26x2 TI Thread User's Guide</a>
      </nav>


      
      <div class="wy-nav-content">
        <div class="rst-content">
          

 



<div role="navigation" aria-label="breadcrumbs navigation">
  <ul class="wy-breadcrumbs">
    <li><a href="../thread/index-cc26x2.html">Docs</a> &raquo;</li>
      
    <li>Localization Toolbox</li>
      <li class="wy-breadcrumbs-aside">
        
          
        
      </li>
  </ul>
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <div class="section" id="localization-toolbox">
<h1>Localization Toolbox<a class="headerlink" href="#localization-toolbox" title="Permalink to this headline">¶</a></h1>
<p>The Localization Toolbox, or RTLS Toolbox, is a collection of RTLS (Real Time
Locating System) techniques that can be implemented on TI’s standard Bluetooth
low energy radios in the CC26xx series. These techniques provide raw data that
can be used for locating, tracking, and securely range bounding other
Bluetooth nodes.</p>
<p>The inherent flexibility of the CC26xx RF Core is what enables this
significant extension of function beyond merely communications, and the main
advantages are that customers can start adding RTLS features and security with
little or no extra cost, very little additional energy consumption and no
increase in peak power.</p>
<p>There are two fundamentally different approaches to location finding:</p>
<table border="1" class="docutils">
<colgroup>
<col width="50%" />
<col width="50%" />
</colgroup>
<tbody valign="top">
<tr class="row-odd"><td><strong>Trilateration</strong></td>
<td><strong>Triangulation</strong></td>
</tr>
<tr class="row-even"><td><div class="first last figure">
<img alt="../_images/trilateration.png" src="../_images/trilateration.png" />
</div>
</td>
<td><div class="first last figure">
<img alt="../_images/triangulation.png" src="../_images/triangulation.png" />
</div>
</td>
</tr>
<tr class="row-odd"><td><p class="first">Trilateration is where you know the distance between a reference node and a
target node. This means that the possible locations seen by one locator
constitute a circle, so typically  three locators are needed to find a single
common intersect point. (Assuming a 2D scenario)</p>
<p class="last"><a class="reference internal" href="#sec-aoa"><span class="std std-ref">Angle of Arrival</span></a> gives you the angle from the receiver to the transmitter.</p>
</td>
<td><p class="first">Triangulation is where you know the direction from a reference node to a
target node. This means that the possible locations seen by one locator
constitute a straight line,  so two nodes will be enough to determine a single
intersect point. (Assuming a 2D scenario)</p>
<p class="last"><a class="reference internal" href="#sec-tof"><span class="std std-ref">Time of Flight</span></a> gives you the distance from the receiver to the transmitter.</p>
</td>
</tr>
</tbody>
</table>
</div>
<div class="section" id="angle-of-arrival">
<span id="sec-aoa"></span><h1>Angle of Arrival<a class="headerlink" href="#angle-of-arrival" title="Permalink to this headline">¶</a></h1>
<p>Angle-of-Arrival (AoA) is a technique for finding the direction that an incoming
Bluetooth packet is coming from, creating a basis for triangulation.</p>
<p>An array of antennas with
well-defined properties is used, and the receiver will switch quickly between
the individual antennas while measuring the phase shift resulting from the
small differences in path length to the different antenna.</p>
<p>These path length differences will depend on the direction of the incoming RF
waves relative to the antennas in the array. In order to facilitate the phase
measurement, the Bluetooth packet must contain a section of continuous tone
(CT) where there are no phase shifts caused by modulation.</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<p class="last">Future versions of the Bluetooth specification will likely incorporate AoA.
In the meantime this is the implementation on the CC2640R2.</p>
</div>
<div class="section" id="ble-packets">
<h2>BLE Packets<a class="headerlink" href="#ble-packets" title="Permalink to this headline">¶</a></h2>
<p>In order to get a good estimate of ϕ (phase), all other intentional phase shifts
in the signal should be removed. AoA packets (based on the BLE PHY) achieve this
by adding a section of consecutive 1’s as part of the PDU, effectively
transmitting a single tone at the carrier frequency of 250kHz.</p>
<blockquote>
<div><div class="figure align-center">
<img alt="../_images/aoa_packet.png" src="../_images/aoa_packet.png" />
</div>
</div></blockquote>
<p>This gives the receiver time to synchronize the demodulator first, and then
store I and Q samples from the single tone 250kHz section at the end into a
buffer and the buffer can then be post-processed by an AoA application</p>
<p>In TX, the RF Core patch ensures that the tone is inserted in the PDU without
being distorted by the whitening filter and without invalidating the CRC.</p>
<p>In RX, the RF Core patch analyzes the packet and starts capturing samples at the
right time while synchronizing antenna switching. The samples are left in the
RF Core RAM for analysis by the main MCU</p>
<div class="admonition note">
<p class="first admonition-title">Note</p>
<blockquote>
<div>The I/Q Data Sample is the coordinates of your signal as seen down the time
axis. In fact, I/Q data is merely a translation of amplitude and phase data
from a polar coordinate system to a Cartesian (X,Y) coordinate system and
using trigonometry, you can convert the polar coordinate sine wave
information into Cartesian I/Q sine wave data.</div></blockquote>
<div class="last figure align-center">
<img alt="../_images/iq_phasor_diagram.png" src="../_images/iq_phasor_diagram.png" />
</div>
</div>
</div>
<div class="section" id="integration">
<h2>Integration<a class="headerlink" href="#integration" title="Permalink to this headline">¶</a></h2>
<p>Using a special RF Core patch in receive mode, the I and Q samples from the
transmitted 250kHz tone can be captured, pre-processed, and buffered by the
RF Core without any load on the main MCU.</p>
<p>Due to the pre-processing, the application can determine the phase shift without
having to remove DC offset or IF first, significantly simplifying the estimation
process and leaving the application MCU free to do more on top.</p>
<blockquote>
<div><div class="figure align-center">
<img alt="../_images/processing_phase.png" src="../_images/processing_phase.png" />
</div>
</div></blockquote>
<p>The I/Q samples can be captured at a rate of up to 4 MHz and a resolution of
16 bits (32 bits per I/Q data pair) -&gt; 128 bits/μs -&gt; 1kB holds 64 μs and the
buffer size can be up to 2kB (128us of 4MS/s data)</p>
<p>The RF Core can provide control signals directly to the antenna switches through
CC2640’s IOs, and divides the total capture period into slices for each antenna.
The slice length (or antenna dwell time) will determine the accuracy of the
phase measurement (default 4us).</p>
</div>
<div class="section" id="application-example">
<h2>Application Example<a class="headerlink" href="#application-example" title="Permalink to this headline">¶</a></h2>
<p>So, how does I/Q samples are used to estimate the angle? Let’s start by assuming
that we have an array of 2 antennas.</p>
<div class="section" id="antenna-switching">
<h3>Antenna Switching<a class="headerlink" href="#antenna-switching" title="Permalink to this headline">¶</a></h3>
<p>When the receiver gets AoA packets, the RF core will trigger an event. This
event is routed to a DMA and it will trigger a GPTimer. The GPTimer will then
counts down 4us. Once it reaches 4us, it will trigger another event which is
route to another DMA channel to start the antenna switching. All of these are
done prior to I/Q sampling.</p>
</div>
<div class="section" id="i-q-sampling">
<h3>I/Q Sampling<a class="headerlink" href="#i-q-sampling" title="Permalink to this headline">¶</a></h3>
<p>Then, the RF core will start sampling the I/Q data at the beginning of the AoA
tone (0xFF &#64; 250KHz) and the sampled data will be stored at the RF RAM.</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id2">
<div class="code-block-caption"><span class="caption-text">Function in AOACC26XX.c to extract the data.</span><a class="headerlink" href="#id2" title="Permalink to this code">¶</a></div>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1
2
3
4</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="kt">void</span> <span class="nf">AoA_getRxIQ</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="o">*</span><span class="n">packetId</span><span class="p">,</span> <span class="n">AoA_IQSample</span> <span class="o">**</span><span class="n">samples</span><span class="p">)</span>
<span class="p">{</span>
  <span class="p">...</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
<p>The I/Q data can be presented into a X-Y domain with real number I and imaginary
number Q (90 degree difference). As mentioned before, for each period of 250 kHz
signal, we sample 16 I and Q data. If there is no difference, that means that
the I/Q data is the same, therefore the phase between ant_1 sample1 will be the
same to ant_2 sample1.</p>
</div>
<div class="section" id="design-considerations">
<h3>Design Considerations<a class="headerlink" href="#design-considerations" title="Permalink to this headline">¶</a></h3>
<p>Due to the design of the antenna board, there is indeed a phase difference between
the antennas. So we extract the phase difference between ant_1 sample[8 to 15]
and ant2_sample[8 to 15]. The switch among antennas will cause measurement error,
therefore we discard I/Q samples from 0 to 7 when calculating angles.</p>
<blockquote>
<div><div class="figure align-center">
<img alt="../_images/ant1_ant2_samplen.png" src="../_images/ant1_ant2_samplen.png" />
</div>
<div class="figure align-center">
<img alt="../_images/anlge_of_interest.png" src="../_images/anlge_of_interest.png" />
</div>
</div></blockquote>
<p>Here is the code putting I/Q data into 2 dimension and then calculate the angle
difference using arctan(Za*complexconjugate(Zb)).</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id3">
<div class="code-block-caption"><span class="caption-text">Math for angle calculation.</span><a class="headerlink" href="#id3" title="Permalink to this code">¶</a></div>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* Ant_1 Sample_n */</span>
<span class="kt">double</span> <span class="n">complex</span> <span class="n">Za</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span> <span class="o">*</span> <span class="n">sample</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">;</span>

<span class="cm">/* Ant_2 Sample_n */</span>
<span class="kt">double</span> <span class="n">complex</span> <span class="n">Zb</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span> <span class="o">*</span> <span class="n">sample</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">b</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">;</span>

<span class="kt">double</span> <span class="n">complex</span> <span class="n">Zab_rel</span> <span class="o">=</span> <span class="n">Za</span> <span class="o">*</span> <span class="n">conj</span><span class="p">(</span><span class="n">Zb</span><span class="p">);</span>

<span class="cm">/* The phase difference between sample_n ant_1 and sample_n ant_2 */</span>
<span class="kt">int16_t</span> <span class="n">Pab_rel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int16_t</span><span class="p">)(</span><span class="n">carg</span><span class="p">(</span><span class="n">Zab_rel</span><span class="p">)</span> <span class="o">*</span> <span class="n">RadToDeg</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
<p>Something to highlight is that in reality the 250kHz might not be perfect (for
example, could be 255kHz or 245kHZ), therefore, there is slightly phase
difference between ant_1 sample_n and ant_1 sample_(n + 16*1). Therefore
compensation should be applied and we use the same method as before:</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id4">
<div class="code-block-caption"><span class="caption-text">Compensation method.</span><a class="headerlink" href="#id4" title="Permalink to this code">¶</a></div>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="cm">/* Ant_1 Sample_n */</span>
<span class="kt">double</span> <span class="n">complex</span> <span class="n">Za</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span> <span class="o">*</span> <span class="n">sample</span><span class="p">[</span><span class="n">r</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">;</span>

<span class="cm">/* Ant_1 Sample_[n-16] */</span>
<span class="kt">double</span> <span class="n">complex</span> <span class="n">Za_prev</span> <span class="o">=</span> <span class="n">sample</span><span class="p">[</span><span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">i</span> <span class="o">+</span> <span class="n">I</span> <span class="o">*</span> <span class="n">sample</span><span class="p">[</span><span class="n">r</span><span class="o">-</span><span class="mi">1</span><span class="p">][</span><span class="n">a</span><span class="p">][</span><span class="n">i</span><span class="p">].</span><span class="n">q</span><span class="p">;</span>

<span class="kt">double</span> <span class="n">complex</span> <span class="n">Zaa_rel</span> <span class="o">=</span> <span class="n">Za</span> <span class="o">*</span> <span class="n">conj</span><span class="p">(</span><span class="n">Za_prev</span><span class="p">);</span>

<span class="cm">/* The phase difference between sample_n ant_1 and sample_n ant_2 */</span>
<span class="kt">int16_t</span> <span class="n">Paa_rel</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int16_t</span><span class="p">)(</span><span class="n">carg</span><span class="p">(</span><span class="n">Zaa_rel</span><span class="p">)</span> <span class="o">*</span> <span class="n">RadToDeg</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
<p>Because of the none perfect 250kHz tone, the phase difference is aggregated.
Let’s say that every period will have 45 degree of delay. Then when comparing
ant_1 sample_n and ant_1 sample_(n+16*1), the aggregated phase difference is 90
degree. But the real phase difference between every period is only 45. Therefore
the calculated phase difference must be divided by the number of antennas used,
in our case 2.</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id5">
<div class="code-block-caption"><span class="caption-text">Phase difference.</span><a class="headerlink" href="#id5" title="Permalink to this code">¶</a></div>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre>1</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">versus_avg</span><span class="p">[</span><span class="n">a</span><span class="p">][</span><span class="n">b</span><span class="p">]</span> <span class="o">+=</span> <span class="n">Pab_rel</span> <span class="o">-</span> <span class="p">((</span><span class="n">Paa_rel</span> <span class="o">*</span> <span class="n">abs</span><span class="p">(</span><span class="n">a</span><span class="o">-</span><span class="n">b</span><span class="p">))</span> <span class="o">/</span><span class="n">numAnt</span><span class="p">);</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="tuning">
<h2>Tuning<a class="headerlink" href="#tuning" title="Permalink to this headline">¶</a></h2>
<p>The antenna pairs and the frequency channel will also affect I/Q data, therefore
after antenna_versus_avg is acquired, a final tuning is needed in order to add
offsets and change the slope. Those values are calculated based on lab data
collection using a turn table where an AoA receiver is on. Then the data is
collected when the turn table is set to 90 degree and the calculated angle vs.
real angle are compared.</p>
<blockquote>
<div><div class="figure align-center">
<img alt="../_images/lab_tuning.png" src="../_images/lab_tuning.png" />
</div>
</div></blockquote>
<p>As you can see from the image above, the offset is applied to make sure the data
received at 0 degree will derive 0 degree after the calculation and then the
slope is changed to make it fit better with all the rest of the angles.</p>
<p>Also depending on the distance and the angle between two antennas, you will need
to update the following parameters:</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id6">
<div class="code-block-caption"><span class="caption-text">Example of antenna tuning, using boostxl-aoa.</span><a class="headerlink" href="#id6" title="Permalink to this code">¶</a></div>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="n">AoA_AntennaPair</span> <span class="n">pair_A2</span><span class="p">[]</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="p">{</span><span class="cm">/* v12 */</span>
        <span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">.</span><span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">55</span><span class="p">,</span>
        <span class="p">.</span><span class="n">gain</span> <span class="o">=</span> <span class="mf">0.80</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span><span class="cm">/* v23 */</span>
        <span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>
        <span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">.</span><span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">45</span><span class="p">,</span>
        <span class="p">.</span><span class="n">gain</span> <span class="o">=</span> <span class="mf">0.90</span><span class="p">,</span>
    <span class="p">},</span>
    <span class="p">{</span><span class="cm">/* v13 */</span>
        <span class="p">.</span><span class="n">a</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
        <span class="p">.</span><span class="n">b</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>
        <span class="p">.</span><span class="n">sign</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
        <span class="p">.</span><span class="n">offset</span> <span class="o">=</span> <span class="o">-</span><span class="mi">85</span><span class="p">,</span>
        <span class="p">.</span><span class="n">gain</span> <span class="o">=</span> <span class="mf">0.40</span><span class="p">,</span>
    <span class="p">},</span>
<span class="p">};</span>

<span class="kt">uint32_t</span> <span class="n">signalAmplitude_A2</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pair_A2</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pair_A2</span><span class="p">[</span><span class="mi">0</span><span class="p">])];</span>
<span class="kt">int16_t</span> <span class="n">pairAngle_A2</span><span class="p">[</span><span class="k">sizeof</span><span class="p">(</span><span class="n">pair_A2</span><span class="p">)</span> <span class="o">/</span> <span class="k">sizeof</span><span class="p">(</span><span class="n">pair_A2</span><span class="p">[</span><span class="mi">0</span><span class="p">])];</span>

<span class="n">AoA_AntennaResult</span> <span class="n">BOOSTXL_AoA_Result_ArrayA2</span> <span class="o">=</span>
<span class="p">{</span>
    <span class="p">.</span><span class="n">signalStrength</span> <span class="o">=</span> <span class="p">(</span><span class="kt">uint32_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">signalAmplitude_A2</span><span class="p">,</span>
    <span class="p">.</span><span class="n">pairAngle</span> <span class="o">=</span> <span class="p">(</span><span class="kt">int16_t</span> <span class="o">*</span><span class="p">)</span><span class="o">&amp;</span><span class="n">pairAngle_A2</span><span class="p">,</span>
    <span class="p">.</span><span class="n">rssi</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="p">.</span><span class="n">updated</span> <span class="o">=</span> <span class="nb">false</span><span class="p">,</span>
<span class="p">};</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
<p>Also, keep in mind that the frequency of the tone also plays a part of calculated
angle. Therefore a final tuning could be applied here.</p>
<blockquote>
<div><div class="literal-block-wrapper docutils container" id="id7">
<div class="code-block-caption"><span class="caption-text">Frequency tuning, for antenna 1.</span><a class="headerlink" href="#id7" title="Permalink to this code">¶</a></div>
<div class="highlight-c"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre> 1
 2
 3
 4
 5
 6
 7
 8
 9
10
11
12
13
14
15</pre></div></td><td class="code"><div class="highlight"><pre><span></span><span class="k">switch</span><span class="p">(</span><span class="n">antA1Result</span><span class="o">-&gt;</span><span class="n">ch</span><span class="p">)</span>
<span class="p">{</span>
    <span class="cm">/* 2402 MHz */</span>
    <span class="k">case</span> <span class="mi">37</span><span class="o">:</span>
        <span class="n">AoA_A1_freqComp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">10</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="cm">/* 2426 MHz */</span>
    <span class="k">case</span> <span class="mi">38</span><span class="o">:</span>
        <span class="n">AoA_A1_freqComp</span> <span class="o">=</span> <span class="o">-</span><span class="mi">5</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
    <span class="cm">/* 2480 MHz */</span>
    <span class="k">case</span> <span class="mi">39</span><span class="o">:</span>
        <span class="n">AoA_A1_freqComp</span> <span class="o">=</span> <span class="mi">15</span><span class="p">;</span>
    <span class="k">break</span><span class="p">;</span>
<span class="p">}</span>
</pre></div>
</td></tr></table></div>
</div>
</div></blockquote>
</div>
</div>
<div class="section" id="time-of-flight">
<span id="sec-tof"></span><h1>Time of Flight<a class="headerlink" href="#time-of-flight" title="Permalink to this headline">¶</a></h1>
<p>ToF is a technique used for secure range bounding by measuring the round trip
delay of an RF packet exchange.</p>
<p>This is implemented in a Master-Slave configuration, where the Master sends a
challenge and the Slave returns a response after a fixed turn-around time. The
Master can then calculate the round trip delay by measuring the time
difference between transmission of the challenge and reception of the
response, subtracting the (known) fixed turn-around time.</p>
<p>Due to the low-speed nature of a Bluetooth radio when evaluated in a speed-of-
light-context, each individual measurement provides only a very coarse result.
But by performing many measurements, typically several hundred within a few
milliseconds, an average result with much better accuracy can be achieved.</p>
<div class="section" id="theory-of-operation">
<h2>Theory of Operation<a class="headerlink" href="#theory-of-operation" title="Permalink to this headline">¶</a></h2>
<p>Few things are faster than the speed of light, and that speed is known and
constant at <cite>c</cite>. Electromagnetic waves propagate at the speed of light,
and thus an RF packet propagates at the speed of light.</p>
<p>Since the speed is constant, this means that the time it takes for a wave to
propagate is directly proportional to the distance. To find the distance to an
object, we can record the timestamp when we transmit something and compare
this to when the reflection is received, divide by two and multiply by <cite>c</cite>.
This is the operating principle of for example RADAR as well.</p>
<div class="figure" id="id8">
<img alt="../_images/tof_reflection.png" src="../_images/tof_reflection.png" />
<p class="caption"><span class="caption-text"><strong>Reflected EM wave.</strong> If time between transmit and receive is <cite>t</cite>, then
distance <cite>d</cite> is simply <cite>ct/2</cite>.</span></p>
</div>
<p>As opposed to RADAR, the reflector in <code class="docutils literal"><span class="pre">TI</span> <span class="pre">ToF</span></code> is considered <cite>active</cite> as it
does not reflect the outgoing signal meaningfully but instead must actively send
out the “reflection”. In this document and our examples, the signal that is sent
out is called a <code class="docutils literal"><span class="pre">PING</span></code> and the response is called <code class="docutils literal"><span class="pre">ACK</span></code>, or sometimes <code class="docutils literal"><span class="pre">PONG</span></code>.</p>
<p>There are at least two main challenges when doing this form of measurement:</p>
<ul class="simple">
<li>The time the reflector uses between receipt of the <code class="docutils literal"><span class="pre">PING</span></code> and transmission
of the <code class="docutils literal"><span class="pre">PONG</span></code> will affect the measured distance.</li>
<li>Light uses <cite>3.3ns</cite> to travel one meter is, which means that the tick
speed of a clock measuring the time of flight must apparently be at
least <cite>303 MHz</cite> to get 1m spatial resolution.</li>
</ul>
<p>The first challenge is overcome in the TI ToF solution by implementing a
deterministic turn-around time in the slave/reflector device.</p>
<p>The frequency of the radio’s demodulator in the ToF configuration is <cite>8 MHz</cite>,
which means that the temporal resolution is <cite>125 ns</cite>. The resolution of the
final measurement can be improved by oversampling the individual packet
measurements.</p>
<div class="section" id="packet-format">
<h3>Packet format<a class="headerlink" href="#packet-format" title="Permalink to this headline">¶</a></h3>
<p>The modulation format is 2Mbps at 250kHz deviation using a piecewise linear
shaper for the transitions.</p>
<img alt="../_images/aafig-1d4e84fb85bf72f8b0298173b4020dfad1a8afcc.png" src="../_images/aafig-1d4e84fb85bf72f8b0298173b4020dfad1a8afcc.png" />
<p>The packets contain a random pre-shared sync word that is unique for each
frame sent over the air, and that either side will be listening for in their RX
cycle.</p>
<p>The syncword is how the RF circuitry detects that the packet is intended for
the device, and also how the timestamps are generated for the measurements.
The randomness is important to prevent replay or guess-based attacks.</p>
</div>
<div class="section" id="tof-protocol">
<h3>ToF Protocol<a class="headerlink" href="#tof-protocol" title="Permalink to this headline">¶</a></h3>
<p>From the ToF driver’s perspective there must be at least two devices: A
<code class="docutils literal"><span class="pre">Master</span></code> device and a <code class="docutils literal"><span class="pre">Slave</span></code> device.</p>
<p>The devices will listen and transmit on a range of frequencies, and using a
range of sync-words, both provided by the application.</p>
<p>The <strong>slave</strong> is initially in RX, or Receive mode, on the first frequency, and
is listening for the first <code class="docutils literal"><span class="pre">syncword</span></code> in the array provided by the
application.</p>
<p>If the slave receives a matching packet in the initial listening period it
will send an <code class="docutils literal"><span class="pre">ACK/PONG</span></code> and will start following a time-slotted scheme where
it changes frequency and syncwords according to the list provided.</p>
<p>The <strong>master</strong> will send out a packet containing the first sync-word and some
application defined payload. Immediately after this it will go into receive
mode and wait for a slave to reply transmitting the second syncword in the
array.</p>
<p>Similarly, if the master receives a matching <code class="docutils literal"><span class="pre">ACK/PONG</span></code> packet in response
to the initial <code class="docutils literal"><span class="pre">PING</span></code>, it will follow the same time-slotted and frequency-
hopping scheme.</p>
<div class="figure" id="id9">
<p class="plantuml">
<img src="../_images/plantuml-fd1ed169f264f08b3d368d7f312261bb2a799bc9.png" alt="&#64;startuml
participant  &quot;Master device&quot; as Master
participant &quot;Slave device&quot; as Slave

== Initial Sync ==

Master -&gt; Slave: Sw&lt;sub&gt;0&lt;/sub&gt; Freq&lt;sub&gt;0&lt;/sub&gt; PING
activate Master
Master -&gt; Master: Sw&lt;sub&gt;1&lt;/sub&gt;
Master -&gt; Master: No Sync
deactivate Master


Slave -&gt; Slave: Enter initial\nRX: Sw&lt;sub&gt;0&lt;/sub&gt; + Freq&lt;sub&gt;0&lt;/sub&gt;
activate Slave

Master -&gt; Slave: Tx: Sw&lt;sub&gt;0&lt;/sub&gt; Freq&lt;sub&gt;0&lt;/sub&gt; PING
activate Master
Master -&gt; Master: Sw&lt;sub&gt;1&lt;/sub&gt; RX
Slave -&gt; Master: Sw&lt;sub&gt;1&lt;/sub&gt; PONG
deactivate Slave
deactivate Master


== Time-slotted ==

note over Master, Slave
   From here the devices will go to the next
   channel even if no sync is received.
end note

Slave -&gt; Slave: Sw&lt;sub&gt;2&lt;/sub&gt; + Freq&lt;sub&gt;1&lt;/sub&gt; RX
activate Slave
Master -&gt; Slave: Sw&lt;sub&gt;2&lt;/sub&gt; Freq&lt;sub&gt;1&lt;/sub&gt; PING
activate Master
Master -&gt; Master: Sw&lt;sub&gt;3&lt;/sub&gt; RX
Slave -&gt; Master: Sw&lt;sub&gt;3&lt;/sub&gt; Freq&lt;sub&gt;1&lt;/sub&gt; PONG
deactivate Slave
deactivate Master

loop

Slave -&gt; Slave: Sw&lt;sub&gt;n&lt;/sub&gt; + Freq&lt;sub&gt;m&lt;/sub&gt; RX
activate Slave
Master -&gt; Slave: Sw&lt;sub&gt;n&lt;/sub&gt; Freq&lt;sub&gt;m&lt;/sub&gt; PING
activate Master
Master -&gt; Master: Sw&lt;sub&gt;n+1&lt;/sub&gt; RX
Slave -&gt; Master: Sw&lt;sub&gt;n+1&lt;/sub&gt; Freq&lt;sub&gt;m&lt;/sub&gt; PONG
deactivate Slave
deactivate Master

end
&#64;enduml" />
</p>
<p class="caption"><span class="caption-text">ToF measurement-burst sequence</span><a class="headerlink" href="#id9" title="Permalink to this image">¶</a></p>
</div>
<p>If we consider the timing of the packets, we can try to illustrate the time of
flight as the distance between the two first vertical lines below.</p>
<p>You can see that the internal clocks of the two devices are not syncronized,
illustrated by the top line for each device, and you can see the three phases
of a ToF measurement:</p>
<ol class="arabic simple">
<li>Master sends PING, Slave receives</li>
<li>Devices switch RF roles, TX to RX and RX to TX</li>
<li>Response PONG is sent</li>
</ol>
<div class="figure" id="id10">
<img alt="../_images/tof_timing.png" src="../_images/tof_timing.png" />
<p class="caption"><span class="caption-text"><strong>ToF Timing diagram.</strong> See legend below.</span></p>
<div class="legend">
<strong>T</strong><sub>A</sub> - Master sends challenge PING,
<strong>T</strong><sub>B</sub> - Master TX/RX switch,
<strong>T</strong><sub>C</sub> - Master detects Sw correlation,
<strong>T</strong><sub>D</sub> - Slave detects Sw correlation,
<strong>T</strong><sub>E</sub> - Slave TX/RX switch,
<strong>T</strong><sub>F</sub> - Slave sends response PONG,</div>
</div>
</div>
<div class="section" id="application">
<h3>Application<a class="headerlink" href="#application" title="Permalink to this headline">¶</a></h3>
<p>The application has to somehow agree with the peer device(s) what frequencies
should be used, the order of frequencies, and what the list of syncwords should
contain.</p>
<p>In addition, it must call <cite>ToF_run(…)</cite> at appropriate times to initialize the
initial syncword search and the time slotted measurement burst.</p>
<p>This can also be shown as a (very) simplified sequence diagram:</p>
<div class="figure" id="id11">
<p class="plantuml">
<img src="../_images/plantuml-ad0f6a3d84fff5b8cc825b5fbaa09e416638b01d.png" alt="&#64;startuml
participant Application as app
participant ToF_driver as drv
participant RF_driver as rf
participant Radio as radio

activate app
app -&gt; app : Initialize\nToF_Params

app -&gt; drv : ToF_open(..)
activate drv
drv -&gt; drv : Initialize
drv -&gt; rf : RF_open(..)
drv -&gt; app : ToF_Handle
deactivate drv
deactivate app

...

app -&gt; drv : ToF_run(freqs, ...)
activate drv
drv -&gt; rf : RF_schedCmd
deactivate drv
activate rf
rf -&gt; radio : Load patch
activate radio
rf -&gt; radio : Run command
deactivate rf

radio -&gt; radio : Search for\nsync
radio --&gt; : Sw&lt;sub&gt;0&lt;/sub&gt;
radio &lt;-- : Sw&lt;sub&gt;1&lt;/sub&gt;


radio -&gt; radio : Loop until finished\nand store timestamps

radio -&gt; rf : Interrupt
deactivate radio

rf -&gt; drv : Callback
drv -&gt; app : Callback

activate app
app -&gt; drv : ToF_getBurstStats(..)

drv -&gt; drv : Calculate stats\nfrom timestamps

drv -&gt; app : ToF_BurstStats

app -&gt; app : Average a bit

[&lt;- app : Display
&#64;enduml" />
</p>
<p class="caption"><span class="caption-text">Application use of ToF</span><a class="headerlink" href="#id11" title="Permalink to this image">¶</a></p>
</div>
</div>
</div>
<div class="section" id="implementation">
<h2>Implementation<a class="headerlink" href="#implementation" title="Permalink to this headline">¶</a></h2>
<p>From the application, it is relatively simple. You need to:</p>
<ol class="arabic simple">
<li>Initialize</li>
<li>Run</li>
<li>Collect the results</li>
<li>Calibrate</li>
</ol>
<div class="section" id="initialize">
<h3>Initialize<a class="headerlink" href="#initialize" title="Permalink to this headline">¶</a></h3>
<p>The ToF driver needs a parameter struct with some information filled in. The
example has this filled in already, but the most interesting parameters are:</p>
<ul class="simple">
<li><code class="docutils literal"><span class="pre">tofRole</span></code>              - Device role: Master/Slave</li>
<li><code class="docutils literal"><span class="pre">pT1RSSIBuf</span></code>           - Pointer to sample buffer</li>
<li><code class="docutils literal"><span class="pre">pSyncWords</span></code>           - Pointer to array of syncwords</li>
<li><code class="docutils literal"><span class="pre">numBurstSamples</span></code>      - Number of syncwords</li>
<li><code class="docutils literal"><span class="pre">frequencies</span></code>          - Pointer to array of frequencies</li>
<li><code class="docutils literal"><span class="pre">numFreq</span></code>              - Number of frequencies</li>
<li><code class="docutils literal"><span class="pre">pfnTofApplicationCB</span></code>  - Callback after run. Function takes <code class="docutils literal"><span class="pre">uint8_t</span></code> status.</li>
</ul>
<p>The sample buffer must be at least <code class="docutils literal"><span class="pre">numBurstSamples</span> <span class="pre">/</span> <span class="pre">2</span></code> large. The list of
frequencies and the list of syncwords must be identical on both sides.</p>
<p>You must also allocate space for the ToF driver instance, a struct of the type <code class="docutils literal"><span class="pre">ToF_Struct</span></code>.</p>
<p>Once that’s done, you can call <code class="docutils literal"><span class="pre">ToF_Handle</span> <span class="pre">handle</span> <span class="pre">=</span> <span class="pre">TOFCC26XX_open(&amp;tofStruct,</span> <span class="pre">&amp;tofParams);</span></code></p>
</div>
<div class="section" id="run">
<h3>Run<a class="headerlink" href="#run" title="Permalink to this headline">¶</a></h3>
<p>When you call <code class="docutils literal"><span class="pre">TOFCC26XX_run(handle,</span> <span class="pre">tofEndTime)</span></code> it will start immediately.
When combined with Bluetooth, you will get the time in Radio Access Timer
(RAT) ticks from the BLE Stack to use as ToF end-time.</p>
<p>If you are running standalone, an absolute timestamp is still needed, but one
can be finessed by using <code class="docutils literal"><span class="pre">RF_getCurrentTime()</span></code> from <code class="docutils literal"><span class="pre">ti/drivers/RF/h</span></code> and
adding <code class="docutils literal"><span class="pre">4</span> <span class="pre">*</span> <span class="pre">&lt;uSec&gt;</span></code> to that.</p>
</div>
<div class="section" id="collect-the-results">
<h3>Collect the results<a class="headerlink" href="#collect-the-results" title="Permalink to this headline">¶</a></h3>
<p>This is done in the callback function given in the initialization parameters:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="n">ToF_BurstStat</span> <span class="n">tofBurstResults</span><span class="p">[</span><span class="n">TOF_MAX_NUM_FREQ</span><span class="p">]</span> <span class="o">=</span> <span class="p">{</span><span class="mi">0</span><span class="p">};</span>

<span class="kt">void</span> <span class="nf">myCallback</span><span class="p">(</span><span class="kt">uint8_t</span> <span class="n">status</span><span class="p">)</span> <span class="p">{</span>
  <span class="n">TOFCC26XX_getBurstStat</span><span class="p">(</span><span class="n">tofHandle</span><span class="p">,</span> <span class="n">tofBurstResults</span><span class="p">);</span>
  <span class="c1">// Do something</span>
<span class="p">}</span>
</pre></div>
</div>
<p>This function takes the interleaved raw samples and averages them per frequency.</p>
<img alt="../_images/aafig-5d67669dc1ec4fd6a1b6808790ee46c5b9bb070d.png" src="../_images/aafig-5d67669dc1ec4fd6a1b6808790ee46c5b9bb070d.png" />
<p>The raw samples are stored in a flat list (above), but the statistics function
presents them per frequency:</p>
<div class="highlight-c"><div class="highlight"><pre><span></span><span class="k">typedef</span> <span class="k">struct</span>
<span class="p">{</span>
    <span class="kt">uint16_t</span> <span class="n">freq</span><span class="p">;</span>          <span class="c1">// Frequency</span>
    <span class="kt">double</span>   <span class="n">tick</span><span class="p">;</span>          <span class="c1">// Time of Flight in clock ticks, averaged over all valid samples for `freq`</span>
    <span class="kt">double</span>   <span class="n">tickVariance</span><span class="p">;</span>  <span class="c1">// Variance of the tick values</span>
    <span class="kt">uint32_t</span> <span class="n">numOk</span><span class="p">;</span>         <span class="c1">// Number of packets received OK for `freq`</span>
<span class="p">}</span> <span class="n">ToF_BurstStat</span><span class="p">;</span>
</pre></div>
</div>
<p>The tick value can be converted to meters by subtracting the calibrated tick
value at 0 meters and multiplying with <code class="docutils literal"><span class="pre">6.25</span></code>.</p>
<p>The scaling factor is due to the resolution of the radio timer, which is 24
MHz, and the time it takes for light to travel 1 meter two times (back and
forth).</p>
<div class="system-message">
<p class="system-message-title">System Message: WARNING/2 (<tt class="docutils">\begin{align*}
\begin{split}
\text{distance} &amp;= \frac{1}{2}\times\text{t}\times\text{c}\\[16pt]
&amp;= \frac{1}{2}\times\frac{\text{tick}}{24\si{\mega\hertz}}\times\text{c}\\[16pt]
&amp;= \frac{\text{tick}}{2\times24\times10^{6}\text{s}^{-1}} \times 3\times10^{8}\si{\meter/\second}\\[16pt]
&amp;= 6.25\si{\meter}\times\text{tick}
\end{split}
\end{align*}</tt>)</p>
latex exited with error
[stdout]
This is pdfTeX, Version 3.1415926-2.5-1.40.14 (TeX Live 2013/Debian)
 restricted \write18 enabled.
entering extended mode
(./math.tex
LaTeX2e &lt;2011/06/27&gt;
Babel &lt;3.9h&gt; and hyphenation patterns for 2 languages loaded.
(/usr/share/texlive/texmf-dist/tex/latex/base/article.cls
Document Class: article 2007/10/19 v1.4h Standard LaTeX document class
(/usr/share/texlive/texmf-dist/tex/latex/base/size12.clo))
(/usr/share/texlive/texmf-dist/tex/latex/base/inputenc.sty
(/usr/share/texlive/texmf-dist/tex/latex/ucs/utf8x.def))
(/usr/share/texlive/texmf-dist/tex/latex/ucs/ucs.sty
(/usr/share/texlive/texmf-dist/tex/latex/ucs/data/uni-global.def))
(/usr/share/texlive/texmf-dist/tex/latex/amsmath/amsmath.sty
For additional information on amsmath, use the `?' option.
(/usr/share/texlive/texmf-dist/tex/latex/amsmath/amstext.sty
(/usr/share/texlive/texmf-dist/tex/latex/amsmath/amsgen.sty))
(/usr/share/texlive/texmf-dist/tex/latex/amsmath/amsbsy.sty)
(/usr/share/texlive/texmf-dist/tex/latex/amsmath/amsopn.sty))
(/usr/share/texlive/texmf-dist/tex/latex/amscls/amsthm.sty)
(/usr/share/texlive/texmf-dist/tex/latex/amsfonts/amssymb.sty
(/usr/share/texlive/texmf-dist/tex/latex/amsfonts/amsfonts.sty))
(/usr/share/texlive/texmf-dist/tex/latex/anyfontsize/anyfontsize.sty)
(/usr/share/texlive/texmf-dist/tex/latex/tools/bm.sty)
No file math.aux.
(/usr/share/texlive/texmf-dist/tex/latex/ucs/ucsencs.def)
(/usr/share/texlive/texmf-dist/tex/latex/amsfonts/umsa.fd)
(/usr/share/texlive/texmf-dist/tex/latex/amsfonts/umsb.fd)
! Undefined control sequence.
&lt;argument&gt; 24\si 
                 {\mega \hertz }
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; 24\si {\mega 
                        \hertz }
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; 24\si {\mega \hertz 
                               }
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ... {s}^{-1}} \times 3\times 10^{8}\si 
                                                  {\meter /\second }\\[16pt]...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ...}} \times 3\times 10^{8}\si {\meter 
                                                  /\second }\\[16pt] &amp;= 6.25...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ... 3\times 10^{8}\si {\meter /\second 
                                                  }\\[16pt] &amp;= 6.25\si {\met...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ...meter /\second }\\[16pt] &amp;= 6.25\si 
                                                  {\meter }\times \text {tic...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ...second }\\[16pt] &amp;= 6.25\si {\meter 
                                                  }\times \text {tick} \end ...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; 24\si 
                 {\mega \hertz }
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; 24\si {\mega 
                        \hertz }
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; 24\si {\mega \hertz 
                               }
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ... {s}^{-1}} \times 3\times 10^{8}\si 
                                                  {\meter /\second }\\[16pt]...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ...}} \times 3\times 10^{8}\si {\meter 
                                                  /\second }\\[16pt] &amp;= 6.25...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ... 3\times 10^{8}\si {\meter /\second 
                                                  }\\[16pt] &amp;= 6.25\si {\met...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ...meter /\second }\\[16pt] &amp;= 6.25\si 
                                                  {\meter }\times \text {tic...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ...second }\\[16pt] &amp;= 6.25\si {\meter 
                                                  }\times \text {tick} \end ...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; 24\si 
                 {\mega \hertz }
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; 24\si {\mega 
                        \hertz }
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; 24\si {\mega \hertz 
                               }
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ... {s}^{-1}} \times 3\times 10^{8}\si 
                                                  {\meter /\second }\\[16pt]...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ...}} \times 3\times 10^{8}\si {\meter 
                                                  /\second }\\[16pt] &amp;= 6.25...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ... 3\times 10^{8}\si {\meter /\second 
                                                  }\\[16pt] &amp;= 6.25\si {\met...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ...meter /\second }\\[16pt] &amp;= 6.25\si 
                                                  {\meter }\times \text {tic...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ...second }\\[16pt] &amp;= 6.25\si {\meter 
                                                  }\times \text {tick} \end ...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; 24\si 
                 {\mega \hertz }
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; 24\si {\mega 
                        \hertz }
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; 24\si {\mega \hertz 
                               }
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ... {s}^{-1}} \times 3\times 10^{8}\si 
                                                  {\meter /\second }\\[16pt]...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ...}} \times 3\times 10^{8}\si {\meter 
                                                  /\second }\\[16pt] &amp;= 6.25...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ... 3\times 10^{8}\si {\meter /\second 
                                                  }\\[16pt] &amp;= 6.25\si {\met...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ...meter /\second }\\[16pt] &amp;= 6.25\si 
                                                  {\meter }\times \text {tic...
l.21 \end{align*}\end{split}
                            
! Undefined control sequence.
&lt;argument&gt; ...second }\\[16pt] &amp;= 6.25\si {\meter 
                                                  }\times \text {tick} \end ...
l.21 \end{align*}\end{split}
                            
[1] (./math.aux) )
(see the transcript file for additional information)
Output written on math.dvi (1 page, 848 bytes).
Transcript written on math.log.
</div>
</div>
<div class="section" id="calibrate">
<h3>Calibrate<a class="headerlink" href="#calibrate" title="Permalink to this headline">¶</a></h3>
<p>Due to the deterministic but non-zero turn-around time in the slave, it is
necessary to record the average tick value per frequency at a known distance,
and then later subtract the calibrated tick values from the measured result
and add back the calibration distance.</p>
</div>
</div>
<div class="section" id="interleaving-with-bluetooth">
<h2>Interleaving with Bluetooth<a class="headerlink" href="#interleaving-with-bluetooth" title="Permalink to this headline">¶</a></h2>
<p>A Bluetooth LE device in a connection is bound to wake up and transmit or
receive at certain times known as <code class="docutils literal"><span class="pre">Connection</span> <span class="pre">Events</span></code>. The interval between
such events is called a <code class="docutils literal"><span class="pre">Connection</span> <span class="pre">Interval</span></code>.</p>
<img alt="../_images/ditaa-9962ca6d2c7b3373f4b73fe179ba8808380a676a.png" src="../_images/ditaa-9962ca6d2c7b3373f4b73fe179ba8808380a676a.png" />
<p>In the time between the end of one connection event and the start of the next
scheduled connection event, there is time schedule other RF commands.</p>
<p>The available time can vary, but a timestamp is provided in the connection
event complete callback for when Time of Flight has to be finished using the
radio.</p>
</div>
</div>


           </div>
          </div>
          <footer>
  

  <hr/>

  <div role="contentinfo">
    <p>
      <a href="http://www.ti.com/corp/docs/legal/copyright.shtml">2016-2018, Texas Instruments</a>, Texas Instruments Incorporated. All rights reserved. <br>
      <a href="http://www.ti.com/corp/docs/legal/trademark/trademrk.htm">Trademarks</a> | <a href="http://www.ti.com/corp/docs/legal/privacy.shtml">Privacy policy</a> | <a href="http://www.ti.com/corp/docs/legal/termsofuse.shtml">Terms of use</a> | <a href="http://www.ti.com/lsds/ti/legal/termsofsale.page">Terms of sale</a>

    </p>
  </div> 

</footer>

        </div>
      </div>

    </section>

  </div>
  


  

    <script type="text/javascript">
        var DOCUMENTATION_OPTIONS = {
            URL_ROOT:'../',
            VERSION:'1.02.00.00',
            COLLAPSE_INDEX:false,
            FILE_SUFFIX:'.html',
            HAS_SOURCE:  true
        };
    </script>
      <script type="text/javascript" src="../_static/jquery.js"></script>
      <script type="text/javascript" src="../_static/underscore.js"></script>
      <script type="text/javascript" src="../_static/doctools.js"></script>

  

  
  
    <script type="text/javascript" src="../_static/js/theme.js"></script>
  

  
  
  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.StickyNav.enable();
        });

      var menuHeight = window.innerHeight;

      var contentOffset = $(".wy-nav-content-wrap").offset();
      var contentHeight = $(".wy-nav-content-wrap").height();
      var contentBottom = contentOffset.top + contentHeight;

      function setNavbarTop() {
          var scrollTop = $(window).scrollTop();
          var maxTop = scrollTop + menuHeight;

          // If past the header
          if (scrollTop > contentOffset.top && maxTop < contentBottom) {
            stickyTop = scrollTop - contentOffset.top;
          } else if (maxTop > contentBottom) {
            stickyTop = scrollTop - contentOffset.top - (maxTop - contentBottom);
          } else {
            stickyTop = 0;
          }

          $(".wy-nav-side").css("top", stickyTop);
      }

      $(document).ready(function() {
        setNavbarTop();
        $(window).scroll(function () {
          setNavbarTop();
        });

        $('body').on("mousewheel", function () {
            // Remove default behavior
            event.preventDefault();
            // Scroll without smoothing
            var wheelDelta = event.wheelDelta;
            var currentScrollPosition = window.pageYOffset;
            window.scrollTo(0, currentScrollPosition - wheelDelta);
        });
      });
  </script>
  
 <script type="text/javascript">
    $(document).ready(function() {
        $(".toggle > *").hide();
        $(".toggle .header").show();
        $(".toggle .header").click(function() {
            $(this).parent().children().not(".header").toggle(400);
            $(this).parent().children(".header").toggleClass("open");
        })
    });
</script>


</body>
</html>